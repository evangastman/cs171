<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>Heroin and Income</title>


<head lang="en">
    <meta charset="UTF-8">
    <title>Heroin</title>


    <!-- ADD Libraries-->
    <script src="libs/d3/d3.min.js" charset="utf-8"></script>
    <script src="libs/jquery/jquery-2.1.1.min.js" charset="utf-8"></script>
    <script src="libs/bootstrap/js/bootstrap.min.js" charset="utf-8"></script>
    <script src="http://d3js.org/queue.v1.min.js"></script>


    <!--Stylesheets-->
    <link rel="stylesheet" type="text/css" href="libs/bootstrap/css/bootstrap.min.css">

    <!-- Get some nice font-->
    <link href='http://fonts.googleapis.com/css?family=PT+Sans:400,700' rel='stylesheet' type='text/css'>


    <!-- add own vis classes-->
    <!-- // <script src = "js/jsonfunctions.js"></script> -->
    <script src = "js/totalvis.js"></script>
    <script src="js/countvis.js"></script>
    <script src="js/crimevis.js"></script>
    <script src="js/mhvis.js"></script>
    <script src="js/moneyvis.js"></script>
    <script src="js/form.js"></script>



    <!-- add own stylesheet-->
    <link rel="stylesheet" type="text/css" href="css/myStyle.css">

</head>

<style>

body {
  font: 10px sans-serif;
}

.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

.bar {
  fill: orange;
}

.bar:hover {
  fill: orangered ;
}

.x.axis path {
  display: none;
}

.d3-tip {
  line-height: 1;
  font-weight: bold;
  padding: 12px;
  background: rgba(0, 0, 0, 0.8);
  color: #fff;
  border-radius: 2px;
}

 Creates a small triangle extender for the tooltip 
.d3-tip:after {
  box-sizing: border-box;
  display: inline;
  font-size: 10px;
  width: 100%;
  line-height: 1;
  color: rgba(0, 0, 0, 0.8);
  content: "\25BC";
  position: absolute;
  text-align: center;
}

/* Style northward tooltips differently */
.d3-tip.n:after {
  margin: -1px 0 0 0;
  top: 100%;
  left: 0;
}
</style>

<body>

   

    <div class="container">
        <h1>Final Project- Heroin in the Year 2012 Data Visualization</h1>

        <div class="row">
            <div class="col-md-8 col-sm-12">
                <p> The following visualization shows you...
                <br>
                <br>
                </p>

            </div>

        </div>

        <div class="row">
            <div class="col-md-2">
                <button class="btn btn-sm btn-primary" id="all-incomes-btn"> <span class="glyphicon glyphicon-usd"></span> all incomes </button>
            </div>
        </div>

        <label>
        <input type="radio" id="bracketing" name="bracketing" class="brack" value="hi" onclick="bracket_sys=1;" checked>4 brackets</label>
        <label>
        <input type="radio" id="bracketing" name="bracketing" class="brack" value="low" onclick="bracket_sys=2;">7 brackets </label>
<!--
        <form name = "incomeForm" class = "iForm" id = "iForm">
            <p> Choose an income bracket:</p>
            <label> 
                <input type="radio" name="income" value="-1" checked> All incomes </label>
            <label> 
                <input type="radio" name="income" value="1"> Income 1</label>
            <label>
                <input type="radio" name="income" value="2"> Income 2</label>
            <label>
                <input type="radio" name="income" value="3"> Income 3</label>
            <label>
                <input type="radio" name="income" value="4"> Income 4</label>
        </form>

    --> 

        <div class="row">
            <div class="col-md-2">
            </div>
        </div>

        <div class="row">
            <div class="col-md-8" id="moneyVis">
                <h3>MONEYVIS GOES HERE (and totalVis should be to its right)</h3>
                <svg width="650" height="20">
                    <text x="50" y="50"></text>
                </svg>
        </div>

        <div class="row">
            <div class="col-md-8" id="totalVis">
                <svg width="650" height="440">
                    <text x="50" y="50"></text>
                </svg>
            </div>






            </br>

            <!-- NOTE for those in charge: of eye-candy these filters (sex and age) do not apply to totalVis, so these buttons should end up below that in the final layout -->
            <label>
            <input type="radio" id="sex" name="sex" class="sex" value="1" onclick="filters.sex=1;">male</label>
            <label>
            <input type="radio" id="sex" name="sex" class="sex" value="2" onclick="filters.sex=2;">female</label>
            <label>
            <input type="radio" id="sex" name="sex" class="sex" value="-1" onclick="filters.sex=-1;" checked>all</label>
        </br>

            </br>

            <!-- NOTE for those in charge: of eye-candy these filters (sex and age) do not apply to totalVis, so these buttons should end up below that in the final layout -->
            <label>
            <input type="radio" id="age" name="age" class="age" value="1" onclick="filters.age=1;">12-17</label>
            <label>
            <input type="radio" id="age" name="age" class="age" value="2" onclick="filters.age=2;">18-25</label>
            <label>
                <input type="radio" id="age" name="age" class="age" value="3" onclick="filters.age=3;">26-34</label>
            <label>
                <input type="radio" id="age" name="age" class="age" value="4" onclick="filters.age=4;">35-49</label>
            <label>
                <input type="radio" id="age" name="age" class="age" value="5" onclick="filters.age=5;">50+</label>
            <label>
            <input type="radio" id="age" name="age" class="age" value="-1" onclick="filters.age=-1;" checked>all</label>
        </br>






            <div class="row">
                <div class="col-md-4" id="mhVis">
                    <h2> Mental Health </h2>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12" id="crimeVis">
                <h2> Crime</h2>
            </div>
        </div>
    </div>

    <script>

        var dateFormatter = d3.time.format("%Y-%m-%d");

        $(function(){ // this function is called after the HTML document is fully loaded


            //==========================================
            //--- HERE IS WHERE ALL THE MAGIC STARTS --
            //==========================================


            // variables keeping global knowledge of the data
            var allData = [];
            var metaData = {};
            var crimeData = [];
            var mhData = [];

            // metaData is for the 4-bracket system. metaData2 is for the 7-bracket system
            var metaData2 = [];

            // variable storing all the people surveyed
            var totalPop;

            // call this function after Data is loaded, reformatted and bound to the variables
            var initVis = function(){
                    console.log(allData);

            	var that = this;

                var MyEventHandler = new Object();

                //TODO: Instantiate all Vis Objects here

                var money_vis = new MoneyVis(d3.select("#moneyVis"), allData, to_money(metaData), to_money(metaData2), MyEventHandler);

                var total_vis = new TotalVis(d3.select("#totalVis"), allData, to_total(metaData), to_total(metaData2), totalPop, MyEventHandler);

                var crime_vis = new CrimeVis(d3.select("#crimeVis"), crimeData, metaData, MyEventHandler);

                var mh_vis = new mhVis(d3.select("#mhVis"), mhData, metaData, MyEventHandler);

                var form = new Form(d3.select("#iForm"), mhData, crimeData, allData, MyEventHandler)

                // reset to include all income levels
                d3.select("#all-incomes-btn").on("click", function(){
                    console.log("Oy!");
                    filters.income = -1;
                    crimeData = to_crime(allData);
                    crime_vis.onSelectionChange(crimeData);
                    total_vis.onSelectionChange(to_total(metaData));
                });

                // rebracketing
                d3.selectAll(".brack").on("click", function(){
                    filters.income = -1;

                    if(bracket_sys == 1)
                        var md = metaData;
                    else
                        var md = metaData2;

                    money_vis.onSelectionChange(to_money(md));
                    crime_vis.onSelectionChange(to_crime(allData));
                    total_vis.onSelectionChange(to_total(md));
                    //mh_vis.onSelectionChange(to_mh(allData));
                });
                
                // filtering by income (by clicking on a money stack)
                $(MyEventHandler).bind("barClicked", function(event, i){
                    filters.income = i;

                    if(bracket_sys == 1)
                        var md = metaData;
                    else
                        var md = metaData2;

                    crimeData = to_crime(allData);
                    crime_vis.onSelectionChange(crimeData);
                    total_vis.onSelectionChange(to_total(md));
                    //mh_vis.onSelectionChange(to_mh(allData));
                })

                // filter by sex
                d3.selectAll(".sex").on("click", function(){
                    //console.log(filters);
                    crimeData = to_crime(allData);
                    crime_vis.onSelectionChange(crimeData);
                    //mh_vis.onSelectionChange(to_mh(allData));
                });

                // filter by age
                d3.selectAll(".age").on("click", function(){
                    //console.log(filters);
                    crimeData = to_crime(allData);
                    crime_vis.onSelectionChange(crimeData);
                    //mh_vis.onSelectionChange(to_mh(allData));
                });

            }

            // call this function after both files are loaded -- error should be "null" if no error
            var dataLoaded = function (error, _allData, _metaData, _metaData2) {

                if (!error) {

                    allData = _allData;


                    metaData = _metaData;
                    //remember total people surveyed
                    totalPop = to_total(metaData)[0];
                    console.log(to_total(metaData));

                    metaData2 = _metaData2;

                    crimeData = to_crime(allData);

                    mhData = to_mh(allData);

                    initVis();
                }
            }

            var startHere = function(){

                //TODO: load data here and call "dataLoaded" afterwards
                // Hint: http://giscollective.org/d3-queue-js/

                queue()
                    .defer(d3.json, "data/CS171_UsersOnly_JSON.json")
                    .defer(d3.json, "data/CS171_metaData.json")
                    .defer(d3.json, "data/CS171_metaData_7brackets.json")
                    .await(storeDataInObjs)

                function storeDataInObjs(e, users, meta, meta2){
                    dataLoaded(e, users, meta, meta2)
                }
            }

            startHere();

        })
    
     /**
    * Helper function that gets the width of a D3 element
     */
    var getInnerWidth = function(element) {
         var style = window.getComputedStyle(element.node(), null);

        return parseInt(style.getPropertyValue('width'));
    }

    var totalcats = ["number", "HERYR", "HERMON"];

    var crimecats = ["BOOKED", "BKSRVIOL", "BKSMASLT", "BKDRVINF", "BKDRUG", "HERLAWTR"];

    var mhcats = ["MHNSPTR2", "NMHSPTR2", "MHASPTR2"];

    // note: remember to change this when changing bracket_sys
    var moneycats = ["0-20K", "20-50K", "50-75K", "75K+"];
    var moneycats2 = ["0-10K", "10-20K", "20-30K", "30-40K", "40-50K", "50-75K", "75K+"];

    // we're using -1 to signify that there is no parameter by which we want to filter. (we're using -1 instead of null, because we'll be assigning these variables ints when we DO want to filter by a parameter. If we then want to go back to null, javascript can't make an int null)
    var filters = {
        income: -1,
        age: -1,
        sex: -1
    }

    // the dataset provides us with two systems of bracketing. system 1 has 4 brackets; system 2 has 7.
    var bracket_sys = 1;

    /* filter the data! I wrote this function to act on a single datum, and I call it in
    the to_crime and to_mh functions. I think this is more efficient than filtering all
    the data at once, since it means we have to loop through it fewer times. But the
    dataset is obviously small enough that this won't be noticeable, so if you would
    rather filter the data all at once then just turn put this code into a for loop.
    */
    function bigfilter (d){
        // if all categories of filters are -1, don't filter anything and just return true
        if(bracket_sys==1)
            var income_var = "INCOME"
        else
            var income_var = "IRFAMIN3"

        if(filters.income == -1 && filters.age == -1 && filters.sex == -1) {
            return true;
        }

        // else filter
        else {
            if((d[income_var] != filters.income && filters.income != -1)
                || (d["CATAG3"] != filters.age && filters.age != -1)
                || (d["IRSEX"] != filters.sex && filters.sex != -1))
                return false;

            else
                return true; 
        }
    }


    // returns array of length 3: population, heroin users in past year, heroin users in past month
    function to_total(_metadata){
        
        var totaldata = [0, 0, 0];

        if(filters.income == -1){
            for(i in _metadata){
                totaldata[0] += _metadata[i]["number"];
                totaldata[1] += _metadata[i]["HERYR"];
                totaldata[2] += _metadata[i]["HERMON"];
            }

        }

        else{
            for(i in _metadata){
                if(_metadata[i]["INCOME"] == filters.income){
                    totaldata[0] = _metadata[i]["number"];
                    totaldata[1] = _metadata[i]["HERYR"];
                    totaldata[2] = _metadata[i]["HERMON"];
                    break;
                }
            }
        }
        return totaldata;
    }

    // returns array of number of heroin users fitting each crime category
    function to_crime(_data){

        var tempCrimeData = [0, 0, 0, 0, 0, 0];

        for(i in _data){
            //console.log(bigfilter(_data[i]));
            if(bigfilter(_data[i])){
                for(j in crimecats){
                    if(_data[i][crimecats[j]] == 1){
                        tempCrimeData[j] ++;      
                    }
                }
            }
        }

        console.log(tempCrimeData);

        return tempCrimeData;
    }

    // returns array of number of heroin users fitting each mental health category
    function to_mh(_data){

        var mhdata = [0, 0, 0];

        for(i in _data){
            if(bigfilter(_data[i])){
                for(j in mhcats){
                    if(_data[i][mhcats[j]] == 1){
                        mhdata[j] ++;
                    }
                }
            }
            
        }

        return mhdata;
    }

    // returns array of "average" income levels for each income bracket
        // for example, in the bracket [0, 20K), the average is 10
    // I will probbaly need to create a second metadata file for this
        // (one for each system of bracketing)
    function to_money(_metadata){

        if(bracket_sys==1)
            var moneydata = [0, 0, 0, 0];
        else
            var moneydata = [0, 0, 0, 0, 0, 0, 0];

        for(i in _metadata){
            moneydata[i] = _metadata[i]["avg"];
        }

        return moneydata;

    }

    /*
    // returns value of income selection
    function nowLayout () {
        var x = document.forms["incomeForm"]["income"].value;
        return x;
    }

    nowLayout(); */

    </script>

</body>
</html>